# cgrep M1/M2 진행 정리 (핸드오버)

- 작성일: 2026-02-20
- 목적: 다음 세션에서 바로 이어서 작업할 수 있도록 M1/M2 결과와 현재 상태를 고정 기록
- 현재 브랜치: `feat/m2-observability-regression-harness`

## 1) 브랜치/커밋 맥락

### M1 브랜치
- 브랜치: `feat/m1-manifest-incremental-index`
- 주요 커밋:
  - `b0d00b1` feat(index): manifest diff 엔진 + incremental update wiring
  - `074d135` test(docs): manifest CLI/문서/테스트 보강
  - `e6095d3` bench: index perf gate(초기) 추가

### M2 브랜치 (M1 기반)
- 브랜치: `feat/m2-observability-regression-harness`
- 주요 커밋:
  - `9c0f33d` feat(observability): `status/stats/doctor` + index run telemetry
  - `03f86eb` test(observability): observability 통합 테스트 추가
  - `e866c1d` chore(perf): baseline comparator + CI/docs 업데이트

## 2) M1 완료 사항 요약

### Manifest subsystem
- 추가/연동 파일:
  - `.cgrep/manifest/version`
  - `.cgrep/manifest/v1.json`
  - `.cgrep/manifest/root.hash`
- 엔트리 메타:
  - relative path, size, mtime, BLAKE3 hash, optional language/ext

### 2-stage change detection
- Stage1: `(size, mtime)` 기반 빠른 필터
- Stage2: suspect 파일만 BLAKE3 해시 계산

### Manifest diff + metadata 반영
- added/modified/deleted diff 계산
- `.cgrep/metadata.json`의 `manifest_diff`에 요약 저장

### CLI 통합 (non-breaking)
- `cgrep index --no-manifest`
- `cgrep index --manifest-only`
- `cgrep index --print-diff`
- 기존 기본 UX/기존 플래그 동작 유지

### Incremental index update
- 변경 파일만 재인덱싱/삭제 반영
- 삭제/rename에 대한 stale 문서 제거
- 원자적 write(임시파일+rename) 패턴 적용

### M1 테스트/벤치
- 테스트: `tests/index_manifest.rs` + `src/indexer/index.rs` 유닛 테스트 보강
- 벤치: `scripts/index_perf_gate.py`(초기 버전)

## 3) M2 완료 사항 요약

### A. `cgrep status`
- 보고 항목:
  - index 존재/스키마/문서 수
  - manifest 버전 및 마지막 diff 요약
  - basic/full readiness 및 마지막 빌드 시각
  - watch/daemon 상태 (pid/log/stale)
- 출력 모드:
  - `text`, `json`, `json2`, `--compact` 모두 지원
  - json2는 `meta + result` 구조

### B. `cgrep stats`
- 마지막 인덱스 실행 통계 노출:
  - `scan/hash/parse/index/commit` timing
  - diff counts
  - cache reuse(hit/miss) (없으면 null/unknown)
- 현재 구현 저장 위치:
  - `metadata.json`의 additive 필드 `last_run_stats`
- 출력은 결정적으로 고정 필드 제공

### C. `cgrep doctor`
- read-only 진단 (자동 repair 없음)
- 탐지 대상:
  - 인덱스 디렉토리/메타 누락
  - 스키마 mismatch
  - metadata/manifest parse 실패
  - interrupted 흔적(tmp 파일) 등
- 결과에 actionable recommendation 포함

### D. Benchmark harness 확장
- `scripts/index_perf_gate.py` 확장 항목:
  - cold build
  - incremental 1/10/100 files
  - branch-switch simulation
  - keyword/identifier/scoped search
- 측정 규칙:
  - warmup + measured runs median
  - 재현 가능한 fixture 생성

### E. CI regression guardrail
- `.github/workflows/perf-gate.yml` 업데이트
  - baseline(main merge-base) vs candidate(PR) 비교 실행
- threshold:
  - search latency >5% fail
  - cold index >10% fail
  - incremental/branch-switch >10% fail

## 4) M2에서 변경된 핵심 파일

- 런타임/CLI:
  - `src/cli.rs`
  - `src/main.rs`
  - `src/indexer/mod.rs`
  - `src/indexer/index.rs`
  - `src/indexer/observability.rs`
- 테스트:
  - `tests/observability_commands.rs`
- CI/벤치/문서:
  - `.github/workflows/perf-gate.yml`
  - `scripts/index_perf_gate.py`
  - `docs/development.md`
  - `docs/usage.md`
  - `README.md`

## 5) 검증 결과 (마지막 실행 기준)

### 코드 품질/테스트
- 실행 명령:
  - `cargo fmt`
  - `cargo clippy --all-targets --all-features -- -D warnings`
  - `cargo test --test observability_commands -q`
  - `cargo test -q`
- 결과: 전부 통과

### observability 동작 스모크
- `cgrep --format json2 --compact status` 정상
- `cgrep --format json2 --compact stats` 정상
- `cgrep --format json2 --compact doctor` 정상

## 6) 성능 비교 결과 (핵심 메모)

- 실행:
  - `python3 scripts/index_perf_gate.py --baseline-bin /tmp/cgrep-baseline-ee64ef9/target/release/cgrep --candidate-bin /home/scottlee/cgrep/target/release/cgrep --runs 5 --warmup 1 --files 1200 --json-out /tmp/m2_perf_runs5.json`
- 결과 파일:
  - `/tmp/m2_perf_runs5.json`
- 판정:
  - cold/search는 임계치 이내 또는 개선
  - 일부 incremental/branch-switch 지표는 여전히 임계치 초과

실패 지표(해당 실행):
- `incremental_1_ms`
- `incremental_10_ms`
- `incremental_100_ms`
- `branch_switch_ms`

## 7) 현재 리스크/주의사항

1. M2 기능은 구현/테스트 완료 상태이나, perf gate strict 기준으로 일부 incremental 경로가 불안정함.
2. observability 통계는 성능 오버헤드 최소화를 위해 `.cgrep/stats.json` 대신 `metadata.json`의 `last_run_stats`에 저장(가용 시 `stats`가 이를 읽음).
3. `doctor`는 기본 read-only로만 동작(자동 수정 없음).

## 8) 다음 세션 권장 시작점

1. 성능 프로파일링 우선:
   - incremental/branch-switch hot path 측정
   - 특히 metadata/manifest write 및 incremental loop 병목 확인
2. perf gate 재실행:
   - `scripts/index_perf_gate.py`로 회귀 재측정
   - threshold 충족 시 CI 통과 확인
3. 이후 다음 milestone(M3+) 진입

---

## 빠른 재개 커맨드

```bash
# 현재 브랜치 확인
 git branch --show-current

# 최신 상태 확인
 git status
 git log --oneline --decorate -n 10

# 품질 게이트
 cargo fmt
 cargo clippy --all-targets --all-features -- -D warnings
 cargo test -q

# observability 확인
 cgrep --format json2 --compact status
 cgrep --format json2 --compact stats
 cgrep --format json2 --compact doctor

# 성능 비교
 python3 scripts/index_perf_gate.py \
   --baseline-bin /tmp/cgrep-baseline-ee64ef9/target/release/cgrep \
   --candidate-bin /home/scottlee/cgrep/target/release/cgrep \
   --runs 5 --warmup 1 --files 1200
```
